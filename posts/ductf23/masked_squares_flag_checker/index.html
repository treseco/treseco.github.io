<!DOCTYPE html>
<html class="" lang="en"><head>
    
    <meta name="viewport" content="width=device-width" />
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=7" />

    <link
    rel="icon"
    href='/favicon.png'
/>
<link
    rel="shortcut icon"
    href='/favicon.ico'
    type="image/x-icon"
/>
<link
    rel="apple-touch-icon"
    href='/apple-touch-icon.png'
/>

    <link
        rel="icon"
        href='/logo.svg'
        type="image/svg+xml"
    />

<title>
        
            Masked Squares Flag Checker  &ndash;
        
        CT
    </title>

    
    <link href="/symbols-nerd-font/symbols-nerd-font.css" rel="stylesheet" integrity="sha512-lydow8GLOLlYNOtHlksNCmGWWCBsbIEtikXpHzfWqx78HLlyQZHOzyLwPpKol4Th6aCwLUXOfODVYgwrd3nwKQ=="/>
    <link href="/jetbrains-mono/jetbrains-mono.css" rel="stylesheet" integrity="sha512-tJxlgL6v1Y7kFf+qB8SloaAMKnOAw6WouknxXtIjkBux9Y/9aX81EUWOJO8c/3l98DmjG8brr4to7zaez606Fg=="/>

    
    
    <link type="text/css" rel="stylesheet" href=https://treseco.github.io/css/styles.0ea3e9989fc6c27bb0498cd610b6d9ded6962526e50b505d3792fd0711d4f9e482dc5d2aa5b4354def56902c72e5c414a550694cf084d53366e19485f2fdc477.css integrity="sha512-DqPpmJ/GwnuwSYzWELbZ3taWJSblC1BdN5L9BxHU&#43;eSC3F0qpbQ1Te9WkCxy5cQUpVBpTPCE1TNm4ZSF8v3Edw==" />
<meta name="author" content="" />

    
        <meta name="keywords" content='ctf write-up, DUCTF 2023, reversing' />
    
    
        <meta name="description" content="Checker Author: joseph Category: rev Difficulty: easy Points: 218 Solves: 62 Description This program checks the flag based on some simple arithmetic operations.
Files ms_flag_checker - ms_flag_checker: ELF 64-bit LSB pie executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=a8e81b5edf26d75633d7f857771172e81689a563, for GNU/Linux 4.4.0, stripped
Solve Begin by decompiling main with ghidra and cleaning up the code.
undefined8 main(void) { long mask_ptr; byte *mask_info; int *sum_target_ptr; int masked_sum; int flag_ints [36]; char buf [40]; ." />
    

<meta property="og:site_name"
    content='CT' />

    <meta property="og:title" content="Masked Squares Flag Checker" />
    <meta property="og:type" content="article" />
    
    <meta
        property="article:author" content="" />
    <meta
        property="article:published_time"
        content='2023-09-03T19:01:07Z-0500' />
    
        
            <meta property="article:tag" content="ctf write-up" />
        
            <meta property="article:tag" content="DUCTF 2023" />
        
            <meta property="article:tag" content="reversing" />
        
    
    <meta property="og:url" content="https://treseco.github.io/posts/ductf23/masked_squares_flag_checker/" />
    
    
    <meta property="og:image"
        content="https://treseco.github.io/icon512.png" />
    
        <meta property="og:description" content="Masked Squares Flag Checker Author: joseph Category: rev Difficulty: easy Points: 218 Solves: 62 Description This program checks the flag based on some simple a" />
    

<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:domain"
      content='reseco.github.io'
/>
<meta property="twitter:url" content="https://treseco.github.io/posts/ductf23/masked_squares_flag_checker/" />


    <meta name="twitter:title" content="Masked Squares Flag Checker" />
    
    
    
    <meta name="twitter:image"
        content="https://treseco.github.io/icon512.png" />
    
        <meta name="twitter:description" content="Masked Squares Flag Checker Author: joseph Category: rev Difficulty: easy Points: 218 Solves: 62 Description This program checks the flag based on some simple a" />
    

<link rel="manifest" href="/manifest/index.json" />
</head>


<body>
        <div id="baseContainer"><header class="">
<div class="titleAndSearchContainer">
        <div id="titleContainer">
            
                <a class="unstyledLink" href="/">
                    <img src='/logo.svg' alt='Logo'/>
                </a>
            
            <div class="rightOfLogo">
                <div class="titleAndHamburger">
                    <h1>
                        <a class="unstyledLink" href="/">CT</a>
                        
                    </h1>
                    
                        <label id="hamburger-menu" for="main-nav-toggler">
                            &#xf85b;
                        </label>
                    
                </div>
                <div id="wide_nav"><nav>
    
        <input type="checkbox" id="main-nav-toggler" />
    
    <ul id="main-nav">
        <li><a href="/">Home</a></li>
        
            <li><a href="/posts/">Posts</a></li>
        
        
        
        
        
            <li><a href="https://treseco.github.io/pages/about/">
                About
            </a></li>
        
        
        
            <li><a href="/tags/">Tags</a></li>
        
        
    </ul>
</nav>
</div>
            </div>
        </div>
        <div class="search">
    <input id="searchbar" type="text" placeholder='Search' />
    <span class="nerdlink" onclick="newSearch();">&#xf002;</span>
</div>
<script>
    function newSearch() {
        let term = searchbar.value.trim();
        if (!term) return;
        location.href = `/search/?q=${term}`;
    }
    searchbar.onkeyup = (ev) => {if (ev.keyCode == 13) newSearch()};
</script>

    </div>
    <div id="links">
        
        
        <a
    
        rel="noreferrer"
    
    target="_blank"
    class="nerdlink"
    href="https://github.com/treseco">
    
    
        &#xf09b;
    
    <span>
        Github
    </span>
</a>

    </div>
    

</header>
<div id="contentContainer">
                <div id="content">
                    <main>
<article class="card single">
    
        <h1>Masked Squares Flag Checker</h1>
    
    
        <p class="date">
            <span title='Date'> </span>
    2023-09-03

</p>
    
    
    
    
    <div><h3 id="masked-squares-flag-checker">Masked Squares Flag Checker</h3>
<ul>
<li>Author: joseph</li>
<li>Category: rev</li>
<li>Difficulty: easy</li>
<li>Points: 218</li>
<li>Solves: 62</li>
</ul>
<hr>
<h4 id="description">Description</h4>
<blockquote>
<p>This program checks the flag based on some simple arithmetic operations.</p>
</blockquote>
<hr>
<h4 id="files">Files</h4>
<p><code>ms_flag_checker</code> - ms_flag_checker: ELF 64-bit LSB pie executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=a8e81b5edf26d75633d7f857771172e81689a563, for GNU/Linux 4.4.0, stripped</p>
<hr>
<h4 id="solve">Solve</h4>
<p>Begin by decompiling main with ghidra and cleaning up the code.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>undefined8 <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">void</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">long</span> mask_ptr;
</span></span><span style="display:flex;"><span>  byte <span style="color:#f92672">*</span>mask_info;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>sum_target_ptr;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> masked_sum;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> flag_ints [<span style="color:#ae81ff">36</span>];
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span> buf [<span style="color:#ae81ff">40</span>];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	...
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//prompt for flag, read in flag
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//convert flag chars to ints and store in flag_ints[36]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  mask_info <span style="color:#f92672">=</span> MASK_INFO_BEGIN;
</span></span><span style="display:flex;"><span>  sum_target_ptr <span style="color:#f92672">=</span> TARGET_SUMS_BEGIN;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">do</span> {
</span></span><span style="display:flex;"><span>    mask_ptr <span style="color:#f92672">=</span> <span style="color:#a6e22e">make_mask</span>((byte <span style="color:#f92672">*</span>)mask_info);
</span></span><span style="display:flex;"><span>    masked_sum <span style="color:#f92672">=</span> <span style="color:#a6e22e">sum_with_mask</span>(flag_ints,mask_ptr);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">*</span>sum_target_ptr <span style="color:#f92672">!=</span> masked_sum) {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;Incorrect!&#34;</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">exit</span>(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    mask_info <span style="color:#f92672">=</span> mask_info[<span style="color:#ae81ff">1</span>];
</span></span><span style="display:flex;"><span>    sum_target_ptr <span style="color:#f92672">=</span> sum_target_ptr <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">while</span> (mask_info <span style="color:#f92672">!=</span> (<span style="color:#a6e22e">byte</span> (<span style="color:#f92672">*</span>) [<span style="color:#ae81ff">24</span>])<span style="color:#f92672">&amp;</span>MASK_INFO_END);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;Correct!&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The <code>main()</code> function of the binary gives us a clear understanding of what this program does.
We just need to pass the check in every loop iteration. The output of the function we will call <code>sum_with_mask()</code> needs to match some value stored in the program data. We can see what <code>sum_with_mask()</code> does.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">sum_with_mask</span>(<span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>flag_ints,<span style="color:#66d9ef">long</span> mask_ptr) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">long</span> idx;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> sum;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">long</span> row_end;
</span></span><span style="display:flex;"><span>  row_end <span style="color:#f92672">=</span> <span style="color:#ae81ff">24</span>;
</span></span><span style="display:flex;"><span>  sum <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">do</span> {
</span></span><span style="display:flex;"><span>    idx <span style="color:#f92672">=</span> row_end <span style="color:#f92672">+</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">24</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">do</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (<span style="color:#f92672">*</span>(<span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>)(mask_ptr <span style="color:#f92672">+</span> idx) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>        sum <span style="color:#f92672">=</span> sum <span style="color:#f92672">+</span> <span style="color:#f92672">*</span>(<span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>)((<span style="color:#66d9ef">long</span>)flag_ints <span style="color:#f92672">+</span> idx);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      idx <span style="color:#f92672">=</span> idx <span style="color:#f92672">+</span> <span style="color:#ae81ff">4</span>;
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">while</span> (idx <span style="color:#f92672">!=</span> row_end);
</span></span><span style="display:flex;"><span>    row_end <span style="color:#f92672">=</span> row_end <span style="color:#f92672">+</span> <span style="color:#ae81ff">24</span>;
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">while</span> (row_end <span style="color:#f92672">!=</span> <span style="color:#ae81ff">168</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> sum;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>This function simply calculates the sum of all elements of <code>flag_ints</code> where the corresponding element in the mask is non-zero. We know that the return value of this function is what is checked in the flag check, and the desired sum is stored in the program data. Using this information we can get the flag knowing what subsets of flag characters sum to what value. We just need all the different character subsets and with the correct sums. In order to find the character subsets we first need the masks, so we need to look at <code>make_mask()</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">make_mask</span>(byte <span style="color:#f92672">*</span>mask_info) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>mask_ptr;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> iterations;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> offset;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> col;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> row;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> byte_val;
</span></span><span style="display:flex;"><span>  byte <span style="color:#f92672">*</span>next_byte;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">bool</span> byte_lte_0;
</span></span><span style="display:flex;"><span>  byte mask_byte;
</span></span><span style="display:flex;"><span>  mask_ptr <span style="color:#f92672">=</span> <span style="color:#a6e22e">malloc</span>(<span style="color:#ae81ff">144</span>);
</span></span><span style="display:flex;"><span>  mask_byte <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>mask_info;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (mask_byte <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    next_byte <span style="color:#f92672">=</span> mask_info <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    row <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    col <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">do</span> {
</span></span><span style="display:flex;"><span>      byte_val <span style="color:#f92672">=</span> (<span style="color:#66d9ef">int</span>)(<span style="color:#66d9ef">char</span>)mask_byte;
</span></span><span style="display:flex;"><span>      byte_lte_0 <span style="color:#f92672">=</span> byte_val <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (byte_lte_0) {
</span></span><span style="display:flex;"><span>        byte_val <span style="color:#f92672">=</span> <span style="color:#f92672">-</span>byte_val;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      iterations <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>      offset <span style="color:#f92672">=</span> col;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">do</span> {
</span></span><span style="display:flex;"><span>        col <span style="color:#f92672">=</span> offset <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">*</span>(uint <span style="color:#f92672">*</span>)((<span style="color:#66d9ef">long</span>)mask_ptr <span style="color:#f92672">+</span> ((<span style="color:#66d9ef">long</span>)offset <span style="color:#f92672">+</span> (<span style="color:#66d9ef">long</span>)row <span style="color:#f92672">*</span> <span style="color:#ae81ff">6</span>) <span style="color:#f92672">*</span> <span style="color:#ae81ff">4</span>) <span style="color:#f92672">=</span> (uint)<span style="color:#f92672">!</span>byte_lte_0;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (col <span style="color:#f92672">==</span> <span style="color:#ae81ff">6</span>) {
</span></span><span style="display:flex;"><span>          row <span style="color:#f92672">=</span> row <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>          col <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        iterations <span style="color:#f92672">=</span> iterations <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>        offset <span style="color:#f92672">=</span> col;
</span></span><span style="display:flex;"><span>      } <span style="color:#66d9ef">while</span> (byte_val <span style="color:#f92672">!=</span> iterations);
</span></span><span style="display:flex;"><span>      mask_byte <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>next_byte;
</span></span><span style="display:flex;"><span>      next_byte <span style="color:#f92672">=</span> next_byte <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">while</span> (mask_byte <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>This function allocates space for a mask on the heap, then reads each byte from <code>mask_info</code>. Each byte is interpreted as two&rsquo;s complement. The absolute value of the byte determines how many bits to add to the mask. The sign of the byte determines if those bits are 1 or 0, 1 for positive, 0 for negative. Now that we have this figured out, we can get all the masks from the <code>mask_info</code> in the program data. Then we can use Z3 to add each sum as a constraint on the flag and solve.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> z3 <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span><span style="color:#75715e"># data from ghidra @00104060. array of ints that the sum of the flag chars</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># is checked against after being masked.</span>
</span></span><span style="display:flex;"><span>target_sums_bytes <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\xa1\x05\x00\x00\xfb\x07\x00\x00\xeb\x04\x00\x00\xef\x07\x00\x00\x07\x07\x00\x00\xea\x02\x00\x00\x37\x00\x00\x00\xaa\x05\x00\x00\xcd\x05\x00\x00\x52\x05\x00\x00\x63\x02\x00\x00\x22\x05\x00\x00\x66\x01\x00\x00\x2a\x07\x00\x00\xdc\x05\x00\x00\x4b\x05\x00\x00\xdb\x07\x00\x00\xc6\x07\x00\x00\x93\x07\x00\x00\xc6\x07\x00\x00\x16\x01\x00\x00\x43\x07\x00\x00\x3f\x08\x00\x00\xe6\x05\x00\x00\x78\x03\x00\x00\xc8\x04\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span><span style="color:#75715e"># data from ghidra @001040e0. array of arrays of bytes used to generate masks</span>
</span></span><span style="display:flex;"><span>mask_info <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\xfb\x01\xfe\x01\xff\x03\xfd\x02\xff\x01\xff\x01\xff\x01\xff\x02\xfd\x02\xfe\x02\x00\x00\x00\x00\xff\x01\xfd\x02\xfd\x02\xff\x01\xfe\x03\xff\x01\xff\x07\xff\x03\xff\x02\x00\x00\x00\x00\x00\x00\xff\x01\xff\x01\xff\x02\xff\x01\xfa\x01\xff\x01\xfe\x01\xff\x01\xff\x01\xfc\x03\xff\x01\xfe\x00\x02\xff\x05\xfd\x03\xff\x04\xff\x02\xff\x05\xfd\x02\xfd\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xff\x01\xfd\x01\xff\x01\xfe\x01\xff\x03\xff\x01\xff\x01\xfe\x05\xff\x04\xff\x01\xfd\x00\x00\x00\x01\xfe\x02\xf8\x01\xf9\x02\xff\x01\xfd\x01\xfe\x01\xfc\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xeb\x01\xf2\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xfe\x03\xfc\x04\xfb\x01\xfe\x01\xff\x01\xfe\x01\xfe\x01\xff\x04\xff\x00\x00\x00\x00\x00\x00\x00\xfc\x05\xfd\x01\xfb\x01\xfd\x01\xfe\x05\xfc\x02\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xff\x02\xfc\x01\xff\x04\xfd\x01\xfc\x01\xff\x02\xff\x01\xfd\x01\xff\x02\xfe\x00\x00\x00\x00\x00\xfe\x01\xf8\x01\xff\x01\xfd\x01\xff\x01\xf9\x01\xf8\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\xfe\x05\xff\x01\xf8\x03\xfe\x01\xfe\x01\xfd\x01\xfc\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\xfd\x01\xf7\x01\xfe\x01\xef\x01\xff\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x03\xfb\x04\xff\x01\xfe\x01\xff\x02\xfd\x03\xff\x01\xff\x03\xff\x02\xff\x00\x00\x00\x00\x00\x00\xfe\x02\xfd\x01\xff\x01\xff\x01\xff\x01\xf9\x01\xff\x06\xff\x03\xff\x01\xff\x00\x00\x00\x00\x00\x01\xfb\x01\xfe\x02\xff\x02\xff\x01\xff\x01\xfb\x01\xff\x01\xff\x05\xfc\x00\x00\x00\x00\x00\x00\x02\xfd\x01\xfb\x04\xfe\x03\xfe\x05\xff\x02\xff\x02\xff\x02\x00\x00\x00\x00\x00\x00\x00\x00\x00\xff\x01\xfd\x01\xff\x02\xfe\x01\xff\x07\xfe\x03\xff\x04\xff\x01\xfe\x01\xff\x00\x00\x00\x00\x00\x02\xff\x01\xfe\x02\xff\x02\xfe\x05\xff\x01\xff\x02\xfd\x02\xff\x01\xfe\x02\xff\x01\x00\x00\x00\x01\xfd\x03\xff\x01\xfe\x01\xff\x06\xff\x01\xff\x02\xfe\x01\xff\x01\xff\x03\xff\x02\x00\x00\x00\xf7\x01\xf7\x01\xfb\x01\xf6\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\xff\x02\xfe\x01\xff\x09\xff\x01\xff\x01\xf9\x02\xfe\x01\xfe\x01\x00\x00\x00\x00\x00\x00\x00\xff\x09\xff\x03\xff\x06\xff\x01\xff\x01\xfe\x01\xfd\x01\xfc\x00\x00\x00\x00\x00\x00\x00\x00\x00\xfe\x01\xfd\x01\xff\x02\xfb\x06\xff\x02\xfe\x04\xff\x01\xfc\x00\x00\x00\x00\x00\x00\x00\x00\x00\xfe\x01\xfc\x01\xff\x01\xfe\x01\xfd\x01\xfd\x01\xfd\x03\xfa\x01\xfe\x00\x00\x00\x00\x00\x00\x00\xf8\x04\xfe\x02\xff\x03\xfb\x01\xfe\x02\xff\x01\xfc\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span><span style="color:#75715e"># convert bytes to integers</span>
</span></span><span style="display:flex;"><span>target_sums <span style="color:#f92672">=</span> [int<span style="color:#f92672">.</span>from_bytes(target_sums_bytes[i:i<span style="color:#f92672">+</span><span style="color:#ae81ff">4</span>], <span style="color:#e6db74">&#39;little&#39;</span>) <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">0</span>, len(target_sums_bytes), <span style="color:#ae81ff">4</span>)]
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span><span style="color:#75715e"># process mask info to generate masks as done in func @00101189</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># for each 2&#39;s complement byte in mask info, sign determines 1 or 0 in mask</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># value determines how many 1s or 0s to add to append to the mask</span>
</span></span><span style="display:flex;"><span>masks <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">0</span>, len(mask_info), <span style="color:#ae81ff">24</span>):
</span></span><span style="display:flex;"><span>    mask <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> j <span style="color:#f92672">in</span> range(i, i<span style="color:#f92672">+</span><span style="color:#ae81ff">24</span>):
</span></span><span style="display:flex;"><span>        signed_val <span style="color:#f92672">=</span> mask_info[j] <span style="color:#f92672">-</span> <span style="color:#ae81ff">256</span> <span style="color:#66d9ef">if</span> mask_info[j] <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">128</span> <span style="color:#66d9ef">else</span> mask_info[j]
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> signed_val <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">elif</span> signed_val <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> k <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">0</span>, abs(signed_val)):
</span></span><span style="display:flex;"><span>                mask<span style="color:#f92672">.</span>append(<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> k <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">0</span>, abs(signed_val)):
</span></span><span style="display:flex;"><span>                mask<span style="color:#f92672">.</span>append(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>    masks<span style="color:#f92672">.</span>append(mask)
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>s <span style="color:#f92672">=</span> Solver()
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 36 z3 vars, one for each char in the flag input</span>
</span></span><span style="display:flex;"><span>X <span style="color:#f92672">=</span> [ Int(<span style="color:#e6db74">&#39;x</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">%</span> i) <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">36</span>)]
</span></span><span style="display:flex;"><span><span style="color:#75715e"># only int values of printable ascii</span>
</span></span><span style="display:flex;"><span>s<span style="color:#f92672">.</span>add([ And(X[i] <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span>, X[i] <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">127</span>) <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">36</span>)])
</span></span><span style="display:flex;"><span><span style="color:#75715e"># assume flag prefix</span>
</span></span><span style="display:flex;"><span>s<span style="color:#f92672">.</span>add(X[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">==</span><span style="color:#ae81ff">68</span>) <span style="color:#75715e">#D</span>
</span></span><span style="display:flex;"><span>s<span style="color:#f92672">.</span>add(X[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">==</span><span style="color:#ae81ff">85</span>) <span style="color:#75715e">#U</span>
</span></span><span style="display:flex;"><span>s<span style="color:#f92672">.</span>add(X[<span style="color:#ae81ff">2</span>]<span style="color:#f92672">==</span><span style="color:#ae81ff">67</span>) <span style="color:#75715e">#C</span>
</span></span><span style="display:flex;"><span>s<span style="color:#f92672">.</span>add(X[<span style="color:#ae81ff">3</span>]<span style="color:#f92672">==</span><span style="color:#ae81ff">84</span>) <span style="color:#75715e">#T</span>
</span></span><span style="display:flex;"><span>s<span style="color:#f92672">.</span>add(X[<span style="color:#ae81ff">4</span>]<span style="color:#f92672">==</span><span style="color:#ae81ff">70</span>) <span style="color:#75715e">#F</span>
</span></span><span style="display:flex;"><span>s<span style="color:#f92672">.</span>add(X[<span style="color:#ae81ff">5</span>]<span style="color:#f92672">==</span><span style="color:#ae81ff">123</span>)<span style="color:#75715e">#{</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span><span style="color:#75715e"># add sum constraint for each mask based on required sum in target_sums and </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># summands specified by the mask</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i, m <span style="color:#f92672">in</span> enumerate(masks):
</span></span><span style="display:flex;"><span>    s<span style="color:#f92672">.</span>add(target_sums[i]<span style="color:#f92672">==</span>Sum([ If(b<span style="color:#f92672">!=</span><span style="color:#ae81ff">0</span>, X[j], <span style="color:#ae81ff">0</span>) <span style="color:#66d9ef">for</span> j , b <span style="color:#f92672">in</span> enumerate(m)]))
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>print(s<span style="color:#f92672">.</span>check())
</span></span><span style="display:flex;"><span>print(s<span style="color:#f92672">.</span>model())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># print flag</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> c <span style="color:#f92672">in</span> [ s<span style="color:#f92672">.</span>model()<span style="color:#f92672">.</span>evaluate(X[i]) <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">36</span>) ] :
</span></span><span style="display:flex;"><span>    print(chr(c<span style="color:#f92672">.</span>as_long()), end<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&#39;</span>)
</span></span><span style="display:flex;"><span>print()
</span></span></code></pre></div><p><code>DUCTF{ezzzpzzz_07bcda7bfe81faf43caa}</code></p>
</div>
</article>

    <hr />
    <p class="articleTagsContainer">
        <span> </span>
        <strong>Tags:</strong>
        
            <a
                
                href="/tags/ctf-write-up/">#ctf write-up</a>
        
            <a
                
                href="/tags/ductf-2023/">#DUCTF 2023</a>
        
            <a
                
                href="/tags/reversing/">#reversing</a>
        
    </p>






                    </main><footer>
    <hr />

<p><small>
        2024 &copy; 
    </small></p>
    <p><small>
        <a href='https://gitlab.com/gabmus/hugo-ficurinia'>Ficurinia theme</a> for <a href='https://gohugo.io'>Hugo</a> by <a href='https://gabmus.org'>Gabriele Musco</a>. Licensed under <a href='https://www.gnu.org/licenses/agpl-3.0.html'>GNU AGPLv3</a>.
    </small></p>
</footer>
</div>
            </div>
        </div>


</body>
</html>
